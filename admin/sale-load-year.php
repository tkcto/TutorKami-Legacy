<?phpdate_default_timezone_set("Asia/Kuala_Lumpur");require_once('classes/config.php.inc');$conn = new mysqli(HOSTNAME, DB_USER, DB_PASS, DBNAME);if ($conn->connect_error) {    echo "Connection failed : " . str_replace(DB_USER, '********', $conn->connect_error);    exit();}if (isset($_POST['dataGrid'])) {    $dataGrid = $_POST['dataGrid'];    ?>    <table class="tbl-qa" style="width: 920px;float: left;">        <thead>            <tr>                <th class="table-header" style="font-size:14px;width:120px;border-right: 1px solid black;">                    <center></center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> Revenue</center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> TTP</center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> Refund</center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> GP</center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> %</center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> New Jobs</center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> Total Jobs</center>                </th>                <th class="table-header" style="font-size:14px;width:100px;border-right: 1px solid black;">                    <center> A.Clients</center>                </th>            </tr>        </thead>        <tbody id="bodyYear">            <?php            $sql = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month !='' GROUP BY month ORDER BY FIELD(month,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec') ";            $result = $conn->query($sql);            if ($result->num_rows > 0) {                while ($row = $result->fetch_assoc()) {                    ?>                    <tr class="table-row" id="">                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:120px;text-left: right;" contenteditable="true">                            <?php echo $row['month']; ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: right;" contenteditable="true">                            <?php                            $sqlSumRev = " SELECT SUM(no4) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                            $resultSumRev = $conn->query($sqlSumRev);                            if ($resultSumRev->num_rows > 0) {                                while ($rowSumRev = $resultSumRev->fetch_assoc()) {                                    echo number_format((float) $rowSumRev['total'], 2);                                }                            }                            ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: right;" contenteditable="true">                            <?php                            $totalRefund = 0;                            $Before = 0;                            $After = 0;                            $sqlSum = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $Before = number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                            $sqlSumRefund = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no11 LIKE '%rtc%' ";                            $resultSumRefund = $conn->query($sqlSumRefund);                            if ($resultSumRefund->num_rows > 0) {                                while ($rowSumRefund = $resultSumRefund->fetch_assoc()) {                                    $After = number_format((float) $rowSumRefund['total'], 2, '.', '');                                }                            }                            $totalRefund = $Before - $After;                            echo number_format((float) $totalRefund, 2);                            ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: right;" contenteditable="true">                            <?php                            $sqlSumRefund = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no11 LIKE '%rtc%' ";                            $resultSumRefund = $conn->query($sqlSumRefund);                            if ($resultSumRefund->num_rows > 0) {                                while ($rowSumRefund = $resultSumRefund->fetch_assoc()) {                                    echo number_format((float) $rowSumRefund['total'], 2);                                }                            }                            ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: right;" contenteditable="true">                            <?php                            $equal = 0;                            $rf = 0;                            $equal2 = 0;                            $equal3 = 0;                            $sqlSum = " SELECT SUM(no4) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no7 != '' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $equal = number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                            $sqlSum = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no3 = 'R.F' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $sqlSum2 = " SELECT * FROM tk_sales_sub WHERE id != '" . $rowSum['id'] . "' AND no1 = '" . $rowSum['no1'] . "' AND no2 = '" . $rowSum['no2'] . "' AND main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                                    $resultSum2 = $conn->query($sqlSum2);                                    if ($resultSum2->num_rows > 0) {                                        $rowSum2 = $resultSum2->fetch_assoc();                                        if ($rowSum2['no6'] != '' && $rowSum2['no7'] != '') {                                            $rf += $rowSum['no4'];                                        }                                    }                                }                            }                            $sqlSum = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no7 != '' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $equal2 = number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                            $equal3 = (($equal - $equal2) + $rf);                            echo number_format((float) $equal3, 2);                            ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: center;" contenteditable="true">                            <?php                            $thisVal = 0;                            $equal = 0;                            $rf = 0;                            $equal2 = 0;                            $equal3 = 0;                            $equal4 = 0;                            $sqlSum = " SELECT SUM(no4) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no7 != '' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $equal = number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                            $sqlSum = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no3 = 'R.F' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $sqlSum2 = " SELECT * FROM tk_sales_sub WHERE id != '" . $rowSum['id'] . "' AND no1 = '" . $rowSum['no1'] . "' AND no2 = '" . $rowSum['no2'] . "' AND main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                                    $resultSum2 = $conn->query($sqlSum2);                                    if ($resultSum2->num_rows > 0) {                                        $rowSum2 = $resultSum2->fetch_assoc();                                        if ($rowSum2['no6'] != '' && $rowSum2['no7'] != '') {                                            $rf += $rowSum['no4'];                                        }                                    }                                }                            }                            $sqlSum = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no7 != '' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $equal2 = number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                            $sqlSumRev = " SELECT SUM(no4) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                            $resultSumRev = $conn->query($sqlSumRev);                            if ($resultSumRev->num_rows > 0) {                                while ($rowSumRev = $resultSumRev->fetch_assoc()) {                                    $thisVal = $rowSumRev['total'];                                }                            }                            $equal3 = (($equal - $equal2) + $rf);                            $equal4 = (($equal3 / $thisVal) * 100);                            echo number_format((float) (($equal3 / $thisVal) * 100), 2) . '%';                            ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: center;" contenteditable="true">                            <?php                            $countTotalJob = '0';                            $totalJob = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no11 LIKE '%NJ%'  ";                            $resTotalJob = $conn->query($totalJob);                            $countTotalJob = $resTotalJob->num_rows;                            echo $countTotalJob;                            ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: center;" contenteditable="true">                            <?php                            $countTotalJob = '0';                            $totalJob = " SELECT main_id, month, row_no, no2, no3 FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no2 != '' AND no3 != 'R.F' GROUP BY no2  ";                            $resTotalJob = $conn->query($totalJob);                            $countTotalJob = $resTotalJob->num_rows;                            echo $countTotalJob;                            ?>                        </td>                        <td onClick="editRow(this,'remove','bodyYear');" class="row-data" style="font-size:14px;width:100px;text-align: center;" contenteditable="true">                            <?php                            $array = array();                            $totalClients = " SELECT main_id, month, row_no, no2, no3 FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no2 != '' AND no3 != 'R.F' GROUP BY no2  ";                            $resTotalClients = $conn->query($totalClients);                            if ($resTotalClients->num_rows > 0) {                                while ($rowTotalClients = $resTotalClients->fetch_assoc()) {                                    $GetClients = " SELECT j_id, j_email FROM tk_job WHERE j_id = '" . $rowTotalClients['no2'] . "' ";                                    $resGetClients = $conn->query($GetClients);                                    if ($resGetClients->num_rows > 0) {                                        $rowGetClients = $resGetClients->fetch_assoc();                                        $array[] = $rowGetClients['j_email'];                                    }                                }                            }                            if (!empty($array)) {                                echo count(array_unique($array));                            }                            ?>                        </td>                    </tr>                    <?php                }            }            ?>        </tbody>        <tfoot>            <tr style="border-top: 1px solid black;">                <td class="table-header" style="font-size:14px;width:120px;text-align: left;border-right: 1px solid black;">                    Grand Total                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: right;border-right: 1px solid black;">                    <?php                    $sql = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month !='' GROUP BY month ORDER BY FIELD(month,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec') ";                    $result = $conn->query($sql);                    if ($result->num_rows > 0) {                        $totalFooter = 0;                        while ($row = $result->fetch_assoc()) {                            $sqlSumRev = " SELECT SUM(no4) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                            $resultSumRev = $conn->query($sqlSumRev);                            if ($resultSumRev->num_rows > 0) {                                while ($rowSumRev = $resultSumRev->fetch_assoc()) {                                    $totalFooter += number_format((float) $rowSumRev['total'], 2, '.', '');                                }                            }                        }                        echo number_format($totalFooter, 2);                    }                    ?>                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: right;border-right: 1px solid black;">                    <?php                    $sql = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month !='' GROUP BY month ORDER BY FIELD(month,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec') ";                    $result = $conn->query($sql);                    if ($result->num_rows > 0) {                        $totalFooter = 0;                        $totalRefund = 0;                        $Before = 0;                        $After = 0;                        while ($row = $result->fetch_assoc()) {                            $sqlSum = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $Before += number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                            $sqlSumRefund = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no11 LIKE '%rtc%' ";                            $resultSumRefund = $conn->query($sqlSumRefund);                            if ($resultSumRefund->num_rows > 0) {                                while ($rowSumRefund = $resultSumRefund->fetch_assoc()) {                                    $After += number_format((float) $rowSumRefund['total'], 2, '.', '');                                }                            }                        }                        $totalRefund = $Before - $After;                        echo number_format($totalRefund, 2);                    }                    ?>                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: right;border-right: 1px solid black;">                    <?php                    $sql = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month !='' GROUP BY month ORDER BY FIELD(month,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec') ";                    $result = $conn->query($sql);                    if ($result->num_rows > 0) {                        $totalFooter = 0;                        while ($row = $result->fetch_assoc()) {                            $sqlSumRefund = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no11 LIKE '%rtc%' ";                            $resultSumRefund = $conn->query($sqlSumRefund);                            if ($resultSumRefund->num_rows > 0) {                                while ($rowSumRefund = $resultSumRefund->fetch_assoc()) {                                    $totalFooter += number_format((float) $rowSumRefund['total'], 2, '.', '');                                }                            }                        }                        echo number_format($totalFooter, 2);                    }                    ?>                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: right;border-right: 1px solid black;">                    <?php                    $sql = sprintf("                        SELECT                             TRUNCATE(SUM(no4), 2) as equal,                            TRUNCATE(SUM(no7), 2) as equal2                        FROM tk_sales_sub                        WHERE main_id = '%s'                        AND no7 != ''                        AND row_no != '0' ",                        $dataGrid['mainID']                    );                    $query = $conn->query($sql);                    $result = $query->fetch_assoc();                    $equal = $result['equal'];                    $equal2 = $result['equal2'];                    $sql = sprintf("                        SELECT TRUNCATE(SUM(tkss.no4), 2) AS rf                            FROM tk_sales_sub tkss                        WHERE main_id = '%s'                        AND no3 = 'R.F'                        AND row_no != '0'                                                AND EXISTS(                            SELECT *                                FROM tk_sales_sub                            WHERE id != tkss.id                            AND no1 = tkss.no1                            AND no2 = tkss.no2                            AND main_id = tkss.main_id                            AND row_no != '0'                            AND no6 != ''                            AND no7 != ''                        )",                        $dataGrid['mainID']                    );                    $query = $conn->query($sql);                    $result = $query->fetch_assoc();                    $rf = $result['rf'];                    $equal3 = (($equal - $equal2) + $rf);                    echo number_format($equal3, 2);                    ?>                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: center;border-right: 1px solid black;">                    <?php                    $sql = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month !='' GROUP BY month ORDER BY FIELD(month,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec') ";                    $result = $conn->query($sql);                    if ($result->num_rows > 0) {                        $totalFooter = 0;                        $equal = 0;                        $equalThis = 0;                        $rf = 0;                        $equal2 = 0;                        $equal3 = 0;                        while ($row = $result->fetch_assoc()) {                            $sqlSum = " SELECT SUM(no4) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no7 != '' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $equal += number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                            $sqlSumRev = " SELECT SUM(no4) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                            $resultSumRev = $conn->query($sqlSumRev);                            if ($resultSumRev->num_rows > 0) {                                while ($rowSumRev = $resultSumRev->fetch_assoc()) {                                    $totalFooter += number_format((float) $rowSumRev['total'], 2, '.', '');                                }                            }                            $sqlSum = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no3 = 'R.F' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $sqlSum2 = " SELECT * FROM tk_sales_sub WHERE id != '" . $rowSum['id'] . "' AND no1 = '" . $rowSum['no1'] . "' AND no2 = '" . $rowSum['no2'] . "' AND main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' ";                                    $resultSum2 = $conn->query($sqlSum2);                                    if ($resultSum2->num_rows > 0) {                                        $rowSum2 = $resultSum2->fetch_assoc();                                        if ($rowSum2['no6'] != '' && $rowSum2['no7'] != '') {                                            $rf += $rowSum['no4'];                                        }                                    }                                }                            }                            $sqlSum = " SELECT SUM(no7) as total FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND no7 != '' AND row_no != '0' ";                            $resultSum = $conn->query($sqlSum);                            if ($resultSum->num_rows > 0) {                                while ($rowSum = $resultSum->fetch_assoc()) {                                    $equal2 += number_format((float) $rowSum['total'], 2, '.', '');                                }                            }                        }                        $equal3 = (($equal - $equal2) + $rf);                        echo number_format((($equal3 / $totalFooter) * 100), 2) . '%';                    }                    ?>                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: center;border-right: 1px solid black;">                    <?php                    $sql = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month !='' GROUP BY month ORDER BY FIELD(month,'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec') ";                    $result = $conn->query($sql);                    if ($result->num_rows > 0) {                        $totalFooter = 0;                        $equal = 0;                        $equal2 = 0;                        $equal3 = 0;                        $countTotalJob = '0';                        while ($row = $result->fetch_assoc()) {                            $totalJob = " SELECT * FROM tk_sales_sub WHERE main_id = '" . $dataGrid['mainID'] . "' AND month = '" . $row['month'] . "' AND row_no != '0' AND no11 LIKE '%NJ%'  ";                            $resTotalJob = $conn->query($totalJob);                            $countTotalJob += $resTotalJob->num_rows;                        }                        echo $countTotalJob;                    }                    ?>                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: center;border-right: 1px solid black;">                </td>                <td class="table-header" style="font-size:14px;width:100px;text-align: center;border-right: 1px solid black;">                </td>            </tr>        </tfoot>    </table>    <?php}$conn->close();?>